# é—­åŒ… (Closure)

## ğŸ“– ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ

**é—­åŒ…**æ˜¯ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œç‰¹åˆ«åœ¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­å¹¿æ³›å­˜åœ¨ã€‚ç®€å•æ¥è¯´ï¼š

> **é—­åŒ…æ˜¯æŒ‡ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿè®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ï¼Œå³ä½¿åœ¨å…¶å¤–éƒ¨å‡½æ•°å·²ç»è¿”å›ä¹‹åã€‚**

### ğŸ¤” æ€è€ƒä¸€ä¸‹
åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæƒ³è±¡ä¸€ä¸ªäººç¦»å¼€äº†æˆ¿é—´ï¼Œä½†ä»ç„¶è®°å¾—æˆ¿é—´é‡Œçš„ä¸œè¥¿ã€‚é—­åŒ…å°±åƒè¿™æ · â€”â€” å‡½æ•°"è®°ä½"äº†å®ƒè¢«åˆ›å»ºæ—¶çš„ç¯å¢ƒã€‚

---

## ğŸ” é—­åŒ…çš„å½¢æˆæ¡ä»¶

é—­åŒ…çš„å½¢æˆéœ€è¦æ»¡è¶³ä¸‰ä¸ªåŸºæœ¬æ¡ä»¶ï¼š

1. **åµŒå¥—å‡½æ•°**ï¼šå†…éƒ¨å‡½æ•°è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡
2. **å˜é‡å¼•ç”¨**ï¼šå†…éƒ¨å‡½æ•°å¼•ç”¨äº†å¤–éƒ¨å‡½æ•°çš„å˜é‡
3. **å‡½æ•°è¿”å›**ï¼šå†…éƒ¨å‡½æ•°è¢«è¿”å›æˆ–ä»¥æŸç§æ–¹å¼æš´éœ²åˆ°å¤–éƒ¨

### åŸºç¡€ç¤ºä¾‹

```javascript
function outerFunction(x) {
    // å¤–éƒ¨å‡½æ•°çš„å˜é‡
    let outerVariable = x;
    
    // å†…éƒ¨å‡½æ•°ï¼ˆé—­åŒ…ï¼‰
    function innerFunction(y) {
        // è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡
        return outerVariable + y;
    }
    
    // è¿”å›å†…éƒ¨å‡½æ•°
    return innerFunction;
}

// åˆ›å»ºé—­åŒ…
const closure = outerFunction(10);

// ä½¿ç”¨é—­åŒ…ï¼Œæ­¤æ—¶ outerFunction å·²ç»æ‰§è¡Œå®Œæ¯•
// ä½† innerFunction ä»ç„¶å¯ä»¥è®¿é—® outerVariable
console.log(closure(5)); // è¾“å‡ºï¼š15
```

---

## âš™ï¸ JavaScript ä¸­çš„é—­åŒ…æœºåˆ¶

### è¯æ³•ä½œç”¨åŸŸ (Lexical Scope)

JavaScript ä½¿ç”¨è¯æ³•ä½œç”¨åŸŸï¼Œè¿™æ„å‘³ç€å‡½æ•°çš„ä½œç”¨åŸŸåœ¨å‡½æ•°å®šä¹‰æ—¶å°±ç¡®å®šäº†ï¼Œè€Œä¸æ˜¯åœ¨è°ƒç”¨æ—¶ã€‚

```javascript
let globalVar = "æˆ‘æ˜¯å…¨å±€å˜é‡";

function outerFunc() {
    let outerVar = "æˆ‘æ˜¯å¤–éƒ¨å˜é‡";
    
    function innerFunc() {
        let innerVar = "æˆ‘æ˜¯å†…éƒ¨å˜é‡";
        console.log(globalVar); // å¯ä»¥è®¿é—®å…¨å±€å˜é‡
        console.log(outerVar);  // å¯ä»¥è®¿é—®å¤–éƒ¨å˜é‡
        console.log(innerVar);  // å¯ä»¥è®¿é—®è‡ªå·±çš„å˜é‡
    }
    
    return innerFunc;
}

const myFunc = outerFunc();
myFunc(); // å³ä½¿ outerFunc æ‰§è¡Œå®Œæ¯•ï¼ŒinnerFunc ä»èƒ½è®¿é—® outerVar
```

### æ‰§è¡Œä¸Šä¸‹æ–‡å’Œä½œç”¨åŸŸé“¾

```javascript
function createCounter() {
    let count = 0; // è¿™ä¸ªå˜é‡è¢«"å°é—­"åœ¨é—­åŒ…ä¸­
    
    return {
        increment: function() {
            count++;
            return count;
        },
        decrement: function() {
            count--;
            return count;
        },
        getCount: function() {
            return count;
        }
    };
}

const counter1 = createCounter();
const counter2 = createCounter();

console.log(counter1.increment()); // 1
console.log(counter1.increment()); // 2
console.log(counter2.increment()); // 1 (ç‹¬ç«‹çš„é—­åŒ…ç¯å¢ƒ)

// æ— æ³•ç›´æ¥è®¿é—® count å˜é‡
console.log(counter1.count); // undefined
```

---

## ğŸ’¡ é—­åŒ…çš„å®é™…åº”ç”¨

### 1. æ•°æ®ç§æœ‰åŒ–å’Œå°è£…

é—­åŒ…å¯ä»¥åˆ›å»ºç§æœ‰å˜é‡ï¼Œå®ç°æ•°æ®å°è£…ï¼š

```javascript
function createBankAccount(initialBalance) {
    let balance = initialBalance;
    
    return {
        // å…¬å¼€æ–¹æ³•
        deposit: function(amount) {
            if (amount > 0) {
                balance += amount;
                return `å­˜æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š${balance}`;
            }
            return "å­˜æ¬¾é‡‘é¢å¿…é¡»å¤§äº0";
        },
        
        withdraw: function(amount) {
            if (amount > 0 && amount <= balance) {
                balance -= amount;
                return `å–æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š${balance}`;
            }
            return "å–æ¬¾å¤±è´¥ï¼šé‡‘é¢æ— æ•ˆæˆ–ä½™é¢ä¸è¶³";
        },
        
        getBalance: function() {
            return balance;
        }
    };
}

const myAccount = createBankAccount(1000);
console.log(myAccount.deposit(500));  // å­˜æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š1500
console.log(myAccount.withdraw(200)); // å–æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š1300
console.log(myAccount.getBalance());  // 1300

// balance å˜é‡æ— æ³•ç›´æ¥è®¿é—®ï¼Œå®ç°äº†æ•°æ®ç§æœ‰åŒ–
console.log(myAccount.balance); // undefined
```

### 2. å‡½æ•°å·¥å‚æ¨¡å¼

```javascript
function createMultiplier(multiplier) {
    return function(number) {
        return number * multiplier;
    };
}

// åˆ›å»ºä¸åŒçš„ä¹˜æ³•å™¨
const double = createMultiplier(2);
const triple = createMultiplier(3);
const tenTimes = createMultiplier(10);

console.log(double(5));   // 10
console.log(triple(4));   // 12
console.log(tenTimes(3)); // 30
```

### 3. æ¨¡å—æ¨¡å¼ (Module Pattern)

```javascript
const Calculator = (function() {
    // ç§æœ‰å˜é‡å’Œæ–¹æ³•
    let result = 0;
    
    function validateNumber(num) {
        return typeof num === 'number' && !isNaN(num);
    }
    
    // è¿”å›å…¬å…±æ¥å£
    return {
        add: function(num) {
            if (validateNumber(num)) {
                result += num;
            }
            return this; // é“¾å¼è°ƒç”¨
        },
        
        subtract: function(num) {
            if (validateNumber(num)) {
                result -= num;
            }
            return this;
        },
        
        multiply: function(num) {
            if (validateNumber(num)) {
                result *= num;
            }
            return this;
        },
        
        divide: function(num) {
            if (validateNumber(num) && num !== 0) {
                result /= num;
            }
            return this;
        },
        
        getResult: function() {
            return result;
        },
        
        reset: function() {
            result = 0;
            return this;
        }
    };
})();

// ä½¿ç”¨æ¨¡å—
Calculator.add(10).multiply(2).subtract(5);
console.log(Calculator.getResult()); // 15
```

### 4. äº‹ä»¶å¤„ç†å’Œå›è°ƒå‡½æ•°

```javascript
function setupButton(name) {
    let clickCount = 0;
    
    return function handleClick() {
        clickCount++;
        console.log(`${name} æŒ‰é’®è¢«ç‚¹å‡»äº† ${clickCount} æ¬¡`);
    };
}

// åˆ›å»ºä¸åŒæŒ‰é’®çš„å¤„ç†å™¨
const button1Handler = setupButton("ç™»å½•");
const button2Handler = setupButton("æ³¨å†Œ");

// æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
button1Handler(); // ç™»å½• æŒ‰é’®è¢«ç‚¹å‡»äº† 1 æ¬¡
button1Handler(); // ç™»å½• æŒ‰é’®è¢«ç‚¹å‡»äº† 2 æ¬¡
button2Handler(); // æ³¨å†Œ æŒ‰é’®è¢«ç‚¹å‡»äº† 1 æ¬¡
```

### 5. é˜²æŠ–å’ŒèŠ‚æµå®ç°

```javascript
// é˜²æŠ–å‡½æ•°
function debounce(func, delay) {
    let timeoutId;
    
    return function(...args) {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        clearTimeout(timeoutId);
        
        // è®¾ç½®æ–°çš„å®šæ—¶å™¨
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}

// èŠ‚æµå‡½æ•°
function throttle(func, delay) {
    let lastCallTime = 0;
    
    return function(...args) {
        const now = Date.now();
        
        if (now - lastCallTime >= delay) {
            lastCallTime = now;
            func.apply(this, args);
        }
    };
}

// ä½¿ç”¨ç¤ºä¾‹
const debouncedSearch = debounce(function(query) {
    console.log(`æœç´¢ï¼š${query}`);
}, 300);

const throttledScroll = throttle(function() {
    console.log('æ»šåŠ¨äº‹ä»¶è§¦å‘');
}, 100);
```

### 6. è®°å¿†åŒ– (Memoization)

```javascript
function createMemoizedFunction(fn) {
    const cache = {};
    
    return function(...args) {
        const key = JSON.stringify(args);
        
        if (cache[key]) {
            console.log('ä»ç¼“å­˜è¿”å›ç»“æœ');
            return cache[key];
        }
        
        console.log('è®¡ç®—æ–°ç»“æœ');
        const result = fn.apply(this, args);
        cache[key] = result;
        return result;
    };
}

// åˆ›å»ºä¸€ä¸ªè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„è®°å¿†åŒ–å‡½æ•°
const memoizedFib = createMemoizedFunction(function(n) {
    if (n <= 1) return n;
    return memoizedFib(n - 1) + memoizedFib(n - 2);
});

console.log(memoizedFib(40)); // ç¬¬ä¸€æ¬¡è®¡ç®—
console.log(memoizedFib(40)); // ä»ç¼“å­˜è¿”å›ï¼Œé€Ÿåº¦å¾ˆå¿«
```

---

## âš ï¸ å¸¸è§çš„é—­åŒ…é™·é˜±

### 1. å¾ªç¯ä¸­çš„é—­åŒ…é—®é¢˜

âŒ **é”™è¯¯çš„åšæ³•ï¼š**
```javascript
function createFunctions() {
    const functions = [];
    
    for (var i = 0; i < 3; i++) {
        functions[i] = function() {
            console.log(i); // æ‰€æœ‰å‡½æ•°éƒ½ä¼šè¾“å‡º 3
        };
    }
    
    return functions;
}

const funcs = createFunctions();
funcs[0](); // 3
funcs[1](); // 3
funcs[2](); // 3
```

âœ… **æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆï¼š**

æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ `let` ä»£æ›¿ `var`
```javascript
function createFunctions() {
    const functions = [];
    
    for (let i = 0; i < 3; i++) { // ä½¿ç”¨ let
        functions[i] = function() {
            console.log(i); // æ¯ä¸ªå‡½æ•°éƒ½æœ‰è‡ªå·±çš„ i
        };
    }
    
    return functions;
}
```

æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•° (IIFE)
```javascript
function createFunctions() {
    const functions = [];
    
    for (var i = 0; i < 3; i++) {
        functions[i] = (function(index) {
            return function() {
                console.log(index);
            };
        })(i);
    }
    
    return functions;
}
```

### 2. å†…å­˜æ³„æ¼é£é™©

```javascript
function attachListeners() {
    const element = document.getElementById('myButton');
    const data = new Array(1000000).fill('some data'); // å¤§é‡æ•°æ®
    
    element.onclick = function() {
        // å³ä½¿ä¸ä½¿ç”¨ dataï¼Œé—­åŒ…ä¹Ÿä¼šæŒæœ‰å®ƒçš„å¼•ç”¨
        console.log('æŒ‰é’®è¢«ç‚¹å‡»');
    };
    
    // æ­£ç¡®çš„åšæ³•ï¼šæ˜¾å¼æ¸…ç†
    return function cleanup() {
        element.onclick = null;
        // data ä¼šè¢«åƒåœ¾å›æ”¶
    };
}
```

---

## ğŸ¯ å­¦ä¹ è¦ç‚¹æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µ
1. **é—­åŒ… = å‡½æ•° + è¯æ³•ç¯å¢ƒ**
2. **é—­åŒ…å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡**
3. **æ¯ä¸ªé—­åŒ…éƒ½æœ‰ç‹¬ç«‹çš„å˜é‡ç¯å¢ƒ**

### å®ç”¨ä»·å€¼
- âœ… æ•°æ®ç§æœ‰åŒ–å’Œå°è£…
- âœ… æ¨¡å—æ¨¡å¼å®ç°
- âœ… å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼
- âœ… äº‹ä»¶å¤„ç†å’Œå¼‚æ­¥ç¼–ç¨‹
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆè®°å¿†åŒ–ã€é˜²æŠ–èŠ‚æµï¼‰

### æ³¨æ„äº‹é¡¹
- âš ï¸ é¿å…å¾ªç¯ä¸­çš„é—­åŒ…é™·é˜±
- âš ï¸ æ³¨æ„å†…å­˜æ³„æ¼é£é™©
- âš ï¸ ç†è§£æ‰§è¡Œä¸Šä¸‹æ–‡å’Œä½œç”¨åŸŸé“¾

---

## ğŸš€ è¿›é˜¶å­¦ä¹ å»ºè®®

1. **å®è·µç»ƒä¹ **ï¼šå°è¯•å®ç°è‡ªå·±çš„æ¨¡å—æ¨¡å¼
2. **æºç é˜…è¯»**ï¼šç ”ç©¶çŸ¥ååº“ï¼ˆå¦‚ jQueryã€Lodashï¼‰ä¸­é—­åŒ…çš„ä½¿ç”¨
3. **æ€§èƒ½åˆ†æ**ï¼šä½¿ç”¨å¼€å‘è€…å·¥å…·åˆ†æé—­åŒ…çš„å†…å­˜ä½¿ç”¨
4. **å¼‚æ­¥ç¼–ç¨‹**ï¼šç»“åˆ Promise å’Œ async/await ç†è§£é—­åŒ…åœ¨å¼‚æ­¥åœºæ™¯çš„åº”ç”¨

è®°ä½ï¼š**ç†è§£é—­åŒ…ä¸ä»…æ˜¯æŒæ¡ä¸€ä¸ªè¯­æ³•ç‰¹æ€§ï¼Œæ›´æ˜¯ç†è§£ JavaScript å‡½æ•°å¼ç¼–ç¨‹æ€ç»´çš„å…³é”®ï¼** ğŸ‰